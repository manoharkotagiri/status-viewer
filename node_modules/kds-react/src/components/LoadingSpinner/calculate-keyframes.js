const fs = require('fs')
const path = require('path')

// (x,y) points expressed as percentages, for use in CSS's `clip-path`
const center = ['50%', '50%']
const top = ['50%', '-50%']
const right = ['150%', '50%']
const bottom = ['50%', '150%']
const left = ['-50%', '50%']

// These four are used once each for the final "sliver" in the 4 different orientations
const topLeft = ['0%', '-50%']
const bottomLeft = ['-50%', '100%']
const bottomRight = ['100%', '150%']
const topRight = ['150%', '0%']

// This is what to edit if you want to change the animation.
// It's a list of `clip-path` coordinates that the spinner animation uses as keyframes.
const frames = [
  [bottom, left, left, top],
  [left, left, left, top],
  [topLeft, topLeft, topLeft, top],

  [top, top, top, right],
  [top, top, right, bottom],
  [top, right, bottom, left],

  [right, right, bottom, left],
  [bottom, bottom, bottom, left],
  [bottomLeft, bottomLeft, bottomLeft, left],

  [left, left, left, top],
  [left, left, top, right],
  [left, top, right, bottom],

  [top, right, right, bottom],
  [right, right, right, bottom],
  [bottomRight, bottomRight, bottomRight, bottom],

  [bottom, bottom, bottom, left],
  [bottom, bottom, left, top],
  [bottom, left, top, right],

  [left, left, top, right],
  [top, top, top, right],
  [topRight, topRight, topRight, right],

  [right, right, right, bottom],
  [right, right, bottom, left],
  [right, bottom, left, top]
]

const cssText = `/* <generated-keyframes src="./calculate-keyframes.js"> */
@keyframes kds-spinner-inchworm {
${frames
    .map((frame, i) => {
      const isLastFrame = i === frames.length - 1
      const interval = 1 / frames.length
      const percent = toPercent((i + 1) * interval)
      return `  ${isLastFrame ? '0%,' : ''}${percent} { clip-path: ${polygon(
        frame
      )} }`
    })
    .join('\n')}
}
/* </generated-keyframes> */`

function polygon (points) {
  const cssPoints = points.map(point => point.join(' ')).join(',')
  return `polygon(${cssPoints},${center})` // final point is always the center
}

function toPercent (num) {
  const percent = num * 100
  const places = Number.isInteger(percent) ? 0 : 3
  return parseFloat(percent.toFixed(places)) + '%'
}

const filename = path.join(__dirname, 'LoadingSpinner.css')
const originalFile = fs.readFileSync(filename, 'utf8')
const newFile = originalFile.replace(
  /\/\* <generated-keyframes[\s\S]+<\/generated-keyframes> \*\//,
  cssText
)
fs.writeFileSync(filename, newFile)
