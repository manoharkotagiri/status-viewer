{"version":3,"file":"Image.js","sources":["kds-react/src/components/Image/Image.js"],"sourcesContent":["import React, { Component } from 'react'\nimport PropTypes from 'prop-types'\nimport cx from 'classnames'\nimport { IconImageMissing, IconGroceries } from '../Icon'\n\n/**\n * **Note:** A height **must** be defined on an `Image`'s parent component in order for the various image states to work correctly.\n */\n\nclass Image extends Component {\n  constructor (props) {\n    super(props)\n    this.skeletonRef = React.createRef()\n    this.state = {\n      isLoading: true,\n      isError: false,\n      isWaitingLazily: this.props.loading === 'lazy'\n    }\n    this.handleImageError = this.handleImageError.bind(this)\n    this.handleImageLoad = this.handleImageLoad.bind(this)\n    this.handleLazyImageInView = this.handleLazyImageInView.bind(this)\n  }\n\n  componentDidMount () {\n    if (this.props.loading === 'lazy') {\n      if (Image.intersectionObserver) {\n        Image.DOMElementsToReactElements.set(this.skeletonRef.current, this)\n        Image.intersectionObserver.observe(this.skeletonRef.current)\n      } else {\n        this.handleLazyImageInView()\n      }\n    }\n  }\n\n  static intersectionObserver =\n    typeof window !== 'undefined' &&\n    !(\n      typeof HTMLImageElement !== 'undefined' &&\n      'loading' in HTMLImageElement.prototype\n    ) &&\n    'IntersectionObserver' in window\n      ? new IntersectionObserver(\n        (entries, observer) => {\n          for (const ele of entries) {\n            if (ele.isIntersecting) {\n              const reactEle = Image.DOMElementsToReactElements.get(\n                ele.target\n              )\n              observer.unobserve(ele.target)\n              Image.DOMElementsToReactElements.delete(ele.target)\n              reactEle.handleLazyImageInView()\n            }\n          }\n        },\n        { rootMargin: '3000px' } // the lazy load threshold from chrome on 4G connections.\n      )\n      : null\n\n  static DOMElementsToReactElements = new Map()\n\n  static propTypes = {\n    /** Pass optional classes to the Image wrapper. */\n    className: PropTypes.string,\n    /** Define image source on an image. */\n    src: PropTypes.string,\n    /** Define alt text on an image. */\n    alt: PropTypes.string,\n    /** Kind of icon to show when image src not provided. */\n    icon: PropTypes.elementType,\n    /** How the image should be loaded. */\n    loading: PropTypes.oneOf(['lazy', 'auto', 'eager'])\n  }\n\n  static defaultProps = {\n    className: '',\n    src: '',\n    alt: ''\n  }\n\n  // this is a safeguard for accessability - the alt text will always be present regardless of lazy-loaded status\n  static _1pxPlaceholderImage =\n    'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs='\n\n  handleImageError () {\n    this.setState({\n      isLoading: false,\n      isError: true\n    })\n  }\n\n  handleImageLoad () {\n    this.setState({\n      isLoading: false\n    })\n  }\n\n  handleLazyImageInView () {\n    this.setState({\n      isWaitingLazily: false\n    })\n  }\n\n  render () {\n    const {\n      isSsrd,\n      className,\n      src,\n      alt,\n      icon: Icon,\n      loading,\n      height,\n      width,\n      ...props\n    } = this.props\n    const { isLoading, isError, isWaitingLazily } = this.state\n\n    const image = (\n      <img\n        {...props}\n        src={isWaitingLazily ? Image._1pxPlaceholderImage : src}\n        alt={alt}\n        loading={loading}\n        className=\"kds-Image-img\"\n        height={!isSsrd && isLoading ? 11 : height}\n        width={!isSsrd && isLoading ? 0 : width}\n        onError={this.handleImageError}\n        onLoad={isWaitingLazily ? undefined : this.handleImageLoad}\n      />\n    )\n    /*\n    You probably have questions reading that, I get it. Here are the answers.\n    We can't use hidden={isLoading} because Chrome's native lazy-loading won't work on\n    most hidden images. display:none doesn't work either. See here:\n    https://bugs.chromium.org/p/chromium/issues/detail?id=1016689\n    And for why I'm specifically choosing height 11 and width 0 as a workaround, see here:\n    https://bugs.chromium.org/p/chromium/issues/detail?id=1025746\n    (width in particular is 0 because height gets overridden by CSS)\n    */\n\n    /* This is so non-javascript-y robots can still see images from a server-side render. */\n    const noscriptImage = (\n      <noscript>\n        <img {...props} src={src} alt={alt} className=\"kds-Image-img w-full\" />\n        <link\n          rel=\"stylesheet\"\n          href={`data:text/css,${encodeURI(\n            '.kds-Image-skeleton{display:none !important}'\n          )}`}\n        />\n      </noscript>\n    )\n\n    /** For images without defined `src` props:\n     * If no `icon` prop is defined, it defaults to `IconGroceries`\n     * */\n    const noSrc = this.props.icon ? (\n      Icon && <Icon size=\"xl\" color=\"subdued\" />\n    ) : (\n      <IconGroceries size=\"xl\" color=\"subdued\" />\n    )\n\n    /** If an image has a defined src prop but it errors out, a broken image SVG will be returned.\n     * If no src has been defined, an icon defined by noSrc will be used. */\n    const error = (\n      <div\n        className=\"bg-default-200 h-full w-full flex justify-center items-center\"\n        hidden={!isSsrd && isLoading}\n      >\n        {src ? <IconImageMissing size=\"xl\" color=\"subdued\" /> : noSrc}\n      </div>\n    )\n\n    const skeleton = (\n      <div\n        className=\"bg-default-200 h-full relative overflow-hidden w-full kds-Image-skeleton\"\n        data-testid=\"skeleton\"\n        ref={loading === 'lazy' && this.skeletonRef}\n      />\n    )\n\n    const shouldRenderFallback = (isSsrd && !src) || !isSsrd & isError\n\n    return (\n      <div\n        className={cx(\n          'h-full',\n          'flex',\n          'flex-wrap',\n          'flex-col',\n          'kds-Image-container',\n          'overflow-hidden',\n          className\n        )}\n        aria-busy={!!isLoading}\n      >\n        {shouldRenderFallback ? error : image}\n        {!isSsrd && isLoading && noscriptImage}\n        {!isSsrd && isLoading && skeleton}\n      </div>\n    )\n  }\n}\n\nexport default Image\n"],"names":["Image","props","skeletonRef","React","createRef","state","isLoading","isError","isWaitingLazily","loading","handleImageError","bind","handleImageLoad","handleLazyImageInView","intersectionObserver","DOMElementsToReactElements","set","current","observe","setState","isSsrd","className","src","alt","Icon","icon","height","width","image","_1pxPlaceholderImage","undefined","noscriptImage","encodeURI","noSrc","IconGroceries","error","IconImageMissing","skeleton","shouldRenderFallback","cx","Component","window","HTMLImageElement","prototype","IntersectionObserver","entries","observer","ele","isIntersecting","reactEle","get","target","unobserve","delete","rootMargin","Map"],"mappings":"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"}